Python tool for shipping TCX files from Garmin Connect to Velohero and a local archive. Additional activity data will be merged from and to Strava. There is also a Web based GUI and a installer, so it can be used on mobile devices (Android).
Adapted for my use case, it's more a personal helper than a universal tool. Please see the [Wiki](https://github.com/chs8691/heroscript/wiki) for the description.

# Introducing
Velohero is a platform to store your activity files (e.g. TCX). You can maintain additional data like training type, equipments etc. But you have to upload and maintain it by hand (tapikiik dosn't work fine). 

Strava has a nice app and is good for being connected with other athletes. My Garmin device sends the activity directly to Strava (via Garmin Connect), so I can edit the activity data directly (setting a proper name, used equipment etc.)

Heroscript is the bridge between Strava/Garmin and Velohero. It tooks the original TCX file from Garmin, adds the activity settings from Strava, so it can be uploaded without doing any additional value settings. After that, the TCX file will be archived on my local storage server (ftp supported). To bring this concept to work, all activity values have to be set in Strava.

For Downloading from Garmin Connect, a [fork](https://github.com/chs8691/garmin-connect-export) of [garmin-connect-export](https://github.com/pe-st/garmin-connect-export) to download all new activities is used. 

![Overview](https://github.com/chs8691/heroscript/blob/master/design/Diagram.png)

With the small web client, Heroscript can be used directly with your mobile device. Use the Termux app and install Heroscript directly from GitHub.

![Mobile Usage](https://github.com/chs8691/heroscript/blob/master/design/MobileClientDiagram.png)

But Heroscript has not the approach to be ready-to-use application for the normal athlete. It is a tailored console script, designed for just my specific use case. But may be you have a similar constellation, so this script can help you as a starting point.

# Install on Android Termux
Download and install [Termux](https://termux.com/).

In Termux, install git and clone this repository:
```
pkg install git
git clone https://github.com/chs8691/heroscript.git
cd heroscript
./setup_termux.sh
... #Follow the instructions...
```
## heroscript configuration script (optional)
The config values can be set with the web client. But it is easier, if there is a config script, e.g. in the android download directory. A template for this script config_heroscript.sh:
```
#!/bin/bash

echo "Configure heroscript with my private settings"
~/heroscript/venv/bin/python ~/heroscript/main.py config --velohero_sso_id mysecretheroscriptssoid
~/heroscript/venv/bin/python ~/heroscript/main.py config --garmin_connect_username mygarminconnectuser
~/heroscript/venv/bin/python ~/heroscript/main.py config --garmin_connect_password mytopsecretpassword

# Archiving to local server storage via ftp
~/heroscript/venv/bin/python ~/heroscript/main.py config --archive_dir 'use ftp host=mylocalserverhost username=mylocalserveruser password=topsecretpassword dir=/ChristianDok/Freizeit/Sport/Trainingsdaten/tcx/{YYYY}'

# Add comment to the Strava activity by training type
~/heroscript/venv/bin/python ~/heroscript/main.py config --strava_description 'training_type(pendel)?https://flic.kr/s/aHsm3QRWjT'

# Add comment to the Strava activity by description
~/heroscript/venv/bin/python ~/heroscript/main.py config --strava_description 'strava_name(die runde stunde)?https://www.instagram.com/explore/tags/dierundestunde/'
```
Execute the script
```
cp ../storage/downloads/config_heroscript.sh .
chmod a+x config_heroscript.sh
./config_heroscript.sh
```

## Starting heroscript
```
./start_flask.sh
```

# Installation script on a locale computer
Use this instruction to bring the Python script to work on a Linux computer.

## Python
You need Python 3.x on your local machine. The scripting is done on Ubuntu and should work an all Ubuntu environments, too. To use it on Windows or your own virtual environment, see requirements.txt for the used libraries (generated by pipreqs).
To use lxlm there are some requirements needed, see (https://lxml.de/installation.html). For instance on Debian:
 
```
sudo apt-get build-dep python3-lxml
```

## Velohero
You need a Velohero account, of course. Set up heroscript with the Single-Sign-On ID from Velohero / Hello / Single-Sign-On / Single Sign On ID. For instance: 
 
``` 
$ heroscript config --velohero_sso_id kdRfmIHT6IVH1GI12345BIhaUpwTaQguuzE7FFs4   
``` 

## STRAVA
For STRAVA, you need an to create an API whith a call back domain 'localhost'. From this API, you need the client ID and the Client Secret. Configure heroscript with this values:

``` 
$ venv/bin/python main.py config --strava_client_id 12345  
$ venv/bin/python main.py config --strava_client_secret 509d7ed7ab29c93bb12345a05f3a1627c57e413f  
``` 

## Local Web Server
A local webserver is used for STRAVA authentication. This server has a default port '4312' but can be change with the config command. For instance:

``` 
$ venv/bin/python main.py config --port 4444  
``` 

# Install
Clone the repository and open a shell

## Usage
Heroscript can be explored by using its help:
 
``` 
$ venv/bin/python main.py --help  
``` 

There are a couple of commands, but for the main use case, you just need this one:

### Setup Commands
* config: Settings for authorization, directories etc.
* masterdata: Read equipments from Velohero and Strava and training types from Velohero

### Activity Commands
* load: Read next TCX file from the local download direcory and merge its Strava activity settings
* transfer: Upload activity to Velohero, update Strava activity and move TCX file to the local archive directory

Let's take a look at the same workflow diagram from above. But now with the heroscript commands instead of the action descriptions.

![Overview](https://github.com/chs8691/heroscript/blob/master/design/commands.png)


### Usage Example
Step by step example to show how it works. If you want to download the latest activities from Garmin in the in-directory, you can do this with ![chs8691/garmin-connect-export](https://github.com/chs8691/garmin-connect-export). This is forked from pe-st's one and can download only new activities:

``` 
$ garmin-connect-export --username <YOUR-GARMIN-USER > --password <TOP-SECRET-PASSWORD> -d /home/chris/download -f tcx -s tcx -fp -c new  
``` 
 
This will download all new activities from Garmin Connect into your local directory '/home/chris/download'.

 
If heroscript should not use the default port 4312, specify another one:
 
``` 
$ venv/bin/python main.py config --port 4313
``` 
 
For Velohero you have to set the SSO-ID:
``` 
$ venv/bin/python main.py config -vs feQfmIHT6IVH1GI9SD32BIhaUpwTaQguuzE7XXa2
``` 

Now we can setup the master data.

Velohero's Training Types will be used in heroscript (later on, it is shown how to set a training type in a Strava activity):

![Training Types in Velohero](https://github.com/chs8691/heroscript/blob/master/design/training-types.png)

To use the equipments, you have to maintain all equipments in Velohero and Strava with the same name (other ones will be ignored):
 
![Equipments in Velohero and Strava](https://github.com/chs8691/heroscript/blob/master/design/equipments.png)

This pairs of equipments can now be merged as master data into heroscript. Because this is the first time to connect to Strava, you have to accecpt authoriztion for the heroscript app:

``` 
$ venv/bin/python main.py masterdata --refresh   
$ Collecting data from Velohero..done! From Strava..Starting webbrowser, please authorize heroscript for STRAVA access.  
Waiting 10 sec for your authorization:  0  
``` 

![Strava authorization for heroscript](https://github.com/chs8691/heroscript/blob/master/design/strava_authorization.png)

After accepting the rights, the master data will be merged.

``` 
$ Mapped all (8) Velohero's to Strava's equipments by name.  
``` 

Use list to show the created data. It shoud be something like this:

``` 
$ venv/bin/python main.py masterdata --list  
TYPES  
   * Velohero-ID   75109: Etappe 
   * Velohero-ID    7437: Family  
   * Velohero-ID    7434: Kollegenrunde  
   * Velohero-ID    7436: Leistungstest  
   * Velohero-ID    7433: Pendel <=== Maps STRAVA commute flag  
   * Velohero-ID    7435: Rolle <=== Maps STRAVA indoor flag  
   * Velohero-ID    7431: Training <=== Default type, with no special behavior  
   * Velohero-ID    7432: Wettkampf <=== Flag STRAVA activity as a Competition  
   
 EQUIPMENTS  
     * VELOHERO-ID | STRAVA-ID  | ACTIVITY TYPE        | TRAINING TYPE        | NAME   
  
   Shoes  
      * 17836      | g5418148   | run                  | None                 | Laufschuhe Saucony Ride ISO  
  
   Bikes  
      * 17481      | b6123981   | roadbike             | Family               | Brompton   
      * 3793       | b6123973   | roadbike             | None                 | Colnago Velo   
      * 3792       | b6123970   | mtb                  | None                 | Giant Team MTB  
      * 17480      | b6796903   | roadbike             | Family               | Trek Rad  
      * 16580      | b6123967   | roadbike             | None                 | Votec VRX Pro    
  
   Unspecified  
      * 9991       | None       | None                 | None                 | Sole Runner FX  
      * 10274      | None       | None                 | None                 | TACX Antares  
```
You can set training types in your Strava activity, see below.

Now setup heroscript for download and archive directories:
 
``` 
$ venv/bin/python main.py config --load_dir=/home/chris/download/
$ venv/bin/python main.py config --archive_dir=/home/chris/archive/
``` 

After this setup, we can start processing the activities. Use the load command to read the first TCX file from the load directory into 'Stage' and add the activity data from Strava:
 
``` 
$ venv/bin/python main.py load --strava  
File loaded: /home/chris/download/20190125-070251-activity_3328238068.tcx  
Found activity on Strava  
``` 

Take a look at the 'stage':

``` 
$ venv/bin/python main.py show  
File Name              : /home/chris/download/20190125-070251-activity_3328238068.tcx   
--- ATTRIBUTES ---  
Activity Type          : run (original: running)  
Training Type          : Training  
Route Name             : None  
Equipment Names        : ['Laufschuhe Saucony Ride ISO']  
Name                   : 'Lauf am Morgen'  
Comment                : 'None'  
  
Started at (GMT)       : Fri 19-01-25 06:02  
Distance               : 6.7 km  
Duration               : 01:02:45 h  
Velocity - Pace (total): 6.4 km/h - 09:22/km  
Altitude               : ▲ 166 ▼ 167  [141..240] meters  
--- STRAVA ---
Activity ID            : 2101666553  
Activity Name          : Lauf am Morgen  
Description (generated):  
    ▲ 19.6 m/km  
    Powered by https://github.com/chs8691/heroscript  
--- STATUS ---  
Velohero Workout ID    : None  
Archived to            : None  
``` 

Heroscript reads the Strava activity and tries to map activity type, training type, name, equipment.
Some attributes can be changes with the set command. 

To finalize this activity, use 'transfer' to:  
* upload to Velohero  
* update Strava's description  
* move the TCX file to the archive  

``` 
$ venv/bin/python main.py transfer --velohero --strava --archive  
``` 
That's all and the next load can be done. 

## Strava's activity
To make this mapping work, the activity in Strava has to be maintained before the load is started. 

The activity type will be set automatically by Strava's equipment type.

There are three ways to set the training type:
The commute label will be mapped to training type 'commute' (or Pendel). Or the training type can be set by the equipment's note. For instance to map an activity to training type 'Family' by a specific equipment usage, just set the this note:

``` 
 heroscript.training_type='family'
```
The third way for setting the training type is a title prefix. For instance the training type 'Etappe':

![Training Type as Prefix](https://github.com/chs8691/heroscript/blob/master/design/strava-title.png)
 
# Usage examples
## bash bulk operation 
If there is no need to change an activities data with the --set operator, bulk processing can look like this. 

```
  $ ./gce.sh 60 # Your script for the garmin connector exporter
  Welcome to Garmin Connect Exporter!
  ...
  Querying list of activities 1..60... Done.
  ...
  Downloading: Garmin Connect activity (56/60) [8383910826] Gelnhausen Radfahren 2022-02-27T08:18:57+01:00, 01:55:09, 33.098km
  Excluding  : Garmin Connect activity (57/60) [8304837373]
  Excluding  : Garmin Connect activity (58/60) [8293498719]
  Excluding  : Garmin Connect activity (59/60) [8275630134]
  Excluding  : Garmin Connect activity (60/60) [8263699624]
  Done!
  for n in {1..56}; do venv/bin/python main.py load -s && venv/bin/python main.py transfer -v -a; done;
  ...
```
